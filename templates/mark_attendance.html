{% extends 'base.html' %}
{% block title %}Mark Attendance - {{ event.name }}{% endblock %}

{% block content %}
<div class="container mt-5">

    <h1 class="mb-4 text-center">Mark Attendance for <strong>{{ event.name }}</strong></h1>
    <p class="text-center text-muted">
        Date: {{ event.date_time.strftime('%Y-%m-%d %H:%M') }} | 
        Location: {{ event.location }} | Type: {{ event.type }}
    </p>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert alert-info">
          {% for message in messages %}
            <p>{{ message }}</p>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="row">

        <!-- Barcode Scanner -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-upc-scan"></i> Scan Barcode
                </div>
                <div class="card-body">
                    <div id="scanner-container" style="width: 100%; aspect-ratio: 16/9; border: 1px solid #ddd; border-radius: 5px; overflow: hidden;"></div>

                    <p id="scanner-status" class="mt-2 text-muted">Initializing scanner...</p>

                    <form method="POST" class="mt-3">
                        <input type="text" name="roll_no" class="form-control mb-2" placeholder="Enter Roll No for testing">
                        <button type="submit" class="btn btn-success w-100">Submit Barcode</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Manual Attendance -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <i class="bi bi-person-plus"></i> Manual Attendance
                </div>
                <div class="card-body">
                    <form method="POST">
                        <select name="manual_roll_no" class="form-select mb-3" required>
                            <option value="" disabled selected>Select a member</option>
                            {% for member in members %}
                                <option value="{{ member.roll_no }}">{{ member.name }} ({{ member.roll_no }})</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-warning w-100">Request Manual Attendance</button>
                    </form>
                    <small class="text-muted">Manual requests will be approved by admin.</small>
                </div>
            </div>
        </div>

    </div>

    <!-- Attendees Table -->
    <div class="card shadow-sm">
        <div class="card-header bg-secondary text-white">
            <i class="bi bi-people"></i> Attendees
        </div>
        <div class="card-body p-0">
            <table class="table table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Roll No</th>
                        <th>Name</th>
                        <th>Method</th>
                        <th>Status</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody>
                    {% for a in attendees %}
                        <tr id="row-{{ a.member.roll_no }}">
                            <td>{{ a.member.roll_no }}</td>
                            <td>{{ a.member.name }}</td>
                            <td>
                                <span class="badge bg-info text-dark">{{ a.method|capitalize }}</span>
                            </td>
                            <td>
                                {% if a.status == 'present' %}
                                    <span class="badge bg-success">Present</span>
                                {% elif a.status == 'pending' %}
                                    <span class="badge bg-warning text-dark">Pending</span>
                                {% else %}
                                    <span class="badge bg-danger">Absent</span>
                                {% endif %}
                            </td>
                            <td>{{ a.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- QuaggaJS for Barcode -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script>
let lastScan = null;
const scannerStatus = document.getElementById('scanner-status');

Quagga.init({
    inputStream: { type: "LiveStream", target: document.querySelector('#scanner-container'), constraints: { facingMode: "environment" } },
    decoder: { readers: ["code_128_reader"] }
}, function(err) {
    if(err){ scannerStatus.textContent = "Error initializing scanner"; return; }
    Quagga.start();
    scannerStatus.textContent = "Scanning...";
});

Quagga.onDetected(function(data){
    const roll_no = data.codeResult.code;
    if(lastScan === roll_no) return;
    lastScan = roll_no;
    setTimeout(()=>{ lastScan=null }, 2000);

    scannerStatus.textContent = "Processing " + roll_no + "...";

    fetch('{{ url_for("mark_attendance", event_id=event.id) }}', {
        method: 'POST',
        headers: { 'Content-Type':'application/x-www-form-urlencoded' },
        body: 'roll_no=' + encodeURIComponent(roll_no) + '&ajax=1'
    })
    .then(res=>res.json())
    .then(data=>{
        if(data.success){
            scannerStatus.textContent = 'Scan successful: ' + roll_no;
            const tbody = document.querySelector('#attendees-table tbody');
            let row = document.getElementById('row-'+roll_no);
            if(row) row.remove();
            row = document.createElement('tr');
            row.id = 'row-' + roll_no;
            row.innerHTML = `<td>${roll_no}</td><td>${data.name}</td><td><span class="badge bg-info text-dark">${data.method}</span></td><td><span class="badge bg-success">${data.status}</span></td><td>${data.timestamp}</td>`;
            tbody.prepend(row);
        } else {
            scannerStatus.textContent = 'Scan failed: ' + data.message;
        }
    }).catch(err=>{ console.error(err); scannerStatus.textContent="Error submitting scan"; });
});
</script>
{% endblock %}
